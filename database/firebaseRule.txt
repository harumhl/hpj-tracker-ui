rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read: if signedIn()
    }
    match /categories/{categoryId} {
    	allow create: if signedIn() && createCategory()
    }
    match /goals/{goalId} {
    	allow create: if signedIn() && createGoal()
      allow update: if signedIn() && updateGoal()
      allow delete: if signedIn()
    }
    match /entries/{entryId} {
    	allow create: if signedIn() && createEntry()
      allow delete: if signedIn()

      match /goals/{subentryId} {
      	allow create: if signedIn() && createSubentry()
        allow update: if signedIn() && updateSubentry()
	      allow delete: if signedIn()
      }
      match /basics/{subentryId} {
      	allow create: if signedIn() && createSubbasic()
        allow update: if signedIn() && updateSubbasic()
	      allow delete: if signedIn()
      }
    }

    match /test_categories/{categoryId} {
    	allow create: if signedIn() && createCategory()
    }
    match /test_goals/{goalId} {
    	allow create: if signedIn() && createGoal()
      allow update: if signedIn() && updateGoal()
      allow delete: if signedIn()
    }
    match /test_entries/{entryId} {
    	allow create: if signedIn() && createEntry()
      allow delete: if signedIn()

      match /test_goals/{subentryId} {
      	allow create: if signedIn() && createSubentry()
        allow update: if signedIn() && updateSubentry()
      	allow delete: if signedIn()
      }
      match /test_basics/{subentryId} {
      	allow create: if signedIn() && createSubbasic()
        allow update: if signedIn() && updateSubbasic()
	      allow delete: if signedIn()
      }
    }


    function signedIn() {
      return request.auth.uid == ''
    }
    function existingData() {
      return resource.data;
    }
    function incomingData() {
      return request.resource.data;
    }
    function createCategory() {
    	return incomingData().size() == 1
      && incomingData().keys().hasOnly(['category'])
      && incomingData().category is string
    }
    function createGoal() {
    	return incomingData().size() == 10
      && incomingData().keys().hasOnly(['category', 'name', 'documentId', 'archived', 'goalCount', 'unit', 'countToMinutes', 'expectedTimesOfCompletion', 'subentryDetails', 'details'])
      && incomingData().category is string
      && incomingData().name is string
      && incomingData().documentId is string
      && incomingData().archived is bool
      && incomingData().goalCount is number
      && incomingData().unit is string
      && incomingData().countToMinutes is number
      && (incomingData().subentryDetails is map)
      && (incomingData().details is string || incomingData().details == '')
    }
    function updateGoal() {
    	return incomingData().size() == 10
      && incomingData().keys().hasOnly(['category', 'name', 'documentId', 'archived', 'goalCount', 'unit', 'countToMinutes', 'expectedTimesOfCompletion', 'subentryDetails', 'details'])
      && incomingData().category == existingData().category
      && incomingData().name == existingData().name
      && incomingData().documentId == existingData().documentId
      && incomingData().archived is bool
      && incomingData().goalCount is number
      && incomingData().unit is string
      && incomingData().countToMinutes is number
      && (incomingData().subentryDetails is map)
      && (incomingData().details is string || incomingData().details == '')
    }
    function createEntry() {
    	return incomingData().size() == 1
      && incomingData().keys().hasOnly(['doneDate'])
      && incomingData().doneDate is string
    }
    function createSubentry() {
    	return incomingData().size() == 8
      && incomingData().keys().hasOnly(['category', 'name', 'documentId', 'count', 'goalCount', 'countToMinutes', 'hide', 'subentryDetails'])
      && incomingData().category is string
      && incomingData().name is string
      && incomingData().documentId is string
      && incomingData().count is number
      && incomingData().goalCount is number
      && incomingData().countToMinutes is number
      && incomingData().hide is bool
      && incomingData().subentryDetails is map
    }
    function updateSubentry() {
    	return incomingData().size() == 8
      && incomingData().keys().hasOnly(['category', 'name', 'documentId', 'count', 'goalCount', 'countToMinutes', 'hide', 'subentryDetails'])
      && incomingData().count is number
      && incomingData().category == existingData().category
      && incomingData().name == existingData().name
      && incomingData().documentId == existingData().documentId
      && incomingData().goalCount == existingData().goalCount
      && incomingData().countToMinutes == existingData().countToMinutes
      && incomingData().hide is bool
      && incomingData().subentryDetails is map
    }
    function createSubbasic() {
    	return true
    }
    function updateSubbasic() {
    	return true
    }
  }
}
